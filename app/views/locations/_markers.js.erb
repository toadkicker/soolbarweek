(function ($) {
    $(function () {
//        sm = new Turbolinks.ScrollManager
        $('[data-toggle="popover"]').popover({html: true})
//            .on('shown.bs.popover', sm.scrollToElement(".location-" + this.data.id));
    })

    $(document).on('turbolinks:load', function (event) {
        if ($('.marker').length > 0) {
            return;
        }

        let svg = d3.select("svg");
        let $tbl = d3.select('.locations.table')

        function makeShape(opts, popoverContent) {
            let markerGroup = svg.select("g#markers").append('svg')
                    .attr("id", 'marker-' + opts.id)
                    .attr("x", opts.x)
                    .attr("y", opts.y)
                    .attr("width", opts.width * 2)
                    .attr("height", opts.height * 2)
                    .attr("class", "<%= user_is_admin? ? "marker draggable":"marker" %>")
                    .attr("data-id", `${opts.id}`)
                    .attr("data-toggle", "popover")
                    .attr("data-placement", "top")
                    .attr("data-content", popoverContent)
                    .attr("data-trigger", "hover")
                    <% if user_is_admin? %>
                    .call(d3.drag().on("start", dragstarted).on('drag', dragged).on('end', dragend))
                <% end %>;
            markerGroup.append("rect")
                .attr("transform", opts.transform)
                .attr("fill", opts.fill)
                .attr("id", opts.id)
                .attr("width", opts.width)
                .attr("height", opts.height)

            markerGroup.append("text")
                .attr("x", "0")
                .attr("text-anchor", "middle")
                .attr("y", "13")
                .attr("fill", "#fff")
                .text(opts.number)

        }

        $tbl.selectAll('.location-row').on('mouseover', growMarker);
        $tbl.selectAll('.location-row').on('mouseout', shrinkMarker);

        function growMarker(evt) {
//            let id = d3.select(evt.currentTarget).data('id');
            let target = d3.event.currentTarget;
            let id = target.dataset.id
            let marker = svg.select("#marker-" + id).select('rect')
            marker.attr('transform', "rotate(45) scale(1.25,1.25) translate(-1,-1)")
        }

        function shrinkMarker(evt) {
//            let id = d3.select(evt.currentTarget).data('id');
            let target = d3.event.currentTarget;
            let id = target.dataset.id
            let marker = svg.select("#marker-" + id).select('rect')
            marker.attr('transform', 'rotate(45) scale(1,1)')
        }

        function dragstarted(evt) {
            console.log("DRAGGING");
        }

        function dragged(d) {
            d3.select(this).attr("x", d3.event.x).attr("y", d3.event.y);
        }

        function dragend(d, e, f) {
            $.ajax({
                url: `/locations/${f[0].id.split("-")[1]}`,
                data: {
                    location: {
                        marker_x: f[0].getAttribute("x"),
                        marker_y: f[0].getAttribute("y")
                    }
                },
                method: 'put',
                dataType: "json",
                success: function (xhr, data, status) {
                    //flash message
                    console.info(xhr)
                }
            })
        }

        //fetch markers from api
        <% @locations.each do |marker| %>
        makeShape(<%= marker_attrs(marker).html_safe %>, '<%=  location_address(marker).html_safe %>')
        <% end %>
    })


})(jQuery);
