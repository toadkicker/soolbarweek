<% if !@order_item.nil? && @order_item.errors.any? %>
    <div class="alert alert-danger">
      <ul>
        <% @order_item.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
<% end %>
<% if @order_items.size == 0 %>
    <p class="text-center lead">
      There are no items in your shopping cart. Please <%= link_to "go back", root_path %> and add some items to your
      cart.
    </p>
<% else %>
    <% @order_items.each_with_index do |order_item, idx| %>
        <%= render 'carts/cart_row', event: order_item.event, order_item: order_item, show_total: true, stripe: (idx+1).even? %>
    <% end %>
    <div class="flex-row">
      <div class="text-right justify-content-end">
        <span><%= t('subtotal') %></span>
        <%= humanized_money_with_symbol current_order.set_subtotal %>
        <br>
        <%= content_tag :i, t('payments_by_paypal') %>
        <div id="paypal-button">
        </div>
      </div>
    </div>
<% end %>

<script>
    (function ($) {
        $(document).on('turbolinks:load', function () {
            const CREATE_PAYMENT_URL = "<%= checkout_notify_url %>";
            const EXECUTE_PAYMENT_URL = '<%= checkout_done_url %>';

            paypal.Button.render({

                env: '<%= Rails.env.development? ? 'sandbox' : 'production' %>',
                locale: 'en_US',

                client: {
                    <% if Rails.env.development? %>
                    sandbox: 'Af43QxK2o4zjNu-ZcvSe_4pWxZbFDxXlhJUbSHpiMqj_V1BDRddhGqAus2UDvrWcU4WHDZ1NnKwzGkFw'
                    <% end %>
                    <% if Rails.env.production? %>
                    production: 'AfmfcGrdQykKw3DNybk2ncWEOVWdiA4hjRgMWeSpA3QQzyCSMc_jernaPyRPS-tWfP67jt7qMp34CJV-'
                    <% end %>
                },

                commit: true, // Show a 'Pay Now' button

                payment: function (data, actions) {
                    return actions.payment.create({
                        payment: {
                            transactions: [
                                {
                                    amount: {total: <%= @amount %>, currency: 'USD'}
                                }
                            ]
                        }
                    });
                },

                onAuthorize: function (data, actions) {
                    return actions.payment.execute().then(function (payment) {
                        $('.shopping-cart').html("<%= escape_javascript(render 'carts/thankyou') %>");
                        let csrfToken = $("meta[name='csrf-token']").attr("content");
                        $.ajax({
                            url: CREATE_PAYMENT_URL,
                            data: JSON.stringify(payment),
                            headers: {
                                'X-CSRF-Token': csrfToken
                            }
                        });
                    });
                }

            }, '#paypal-button');
        })
    })(jQuery);
</script>